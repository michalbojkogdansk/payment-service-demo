<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’³ payment-service â€” Live Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --blue: #58a6ff;
      --text: #c9d1d9;
      --muted: #8b949e;
      --font: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 20px;
    }
    header h1 { font-size: 1.1rem; color: var(--text); }
    header h1 span { color: var(--blue); }
    .api-config { display: flex; gap: 8px; align-items: center; }
    .api-config input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-family: var(--font);
      font-size: 0.75rem;
      width: 280px;
    }
    .btn {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      font-family: var(--font);
      font-size: 0.78rem;
      cursor: pointer;
      transition: opacity .2s;
    }
    .btn:hover { opacity: .8; }
    .btn-blue { background: var(--blue); color: #000; }
    .btn-red  { background: var(--red); color: #fff; }
    .btn-green{ background: var(--green); color: #000; }
    .btn-muted{ background: var(--border); color: var(--text); }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: auto auto;
      gap: 16px;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
    }
    .card-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* Status */
    #status-card { grid-column: 1; grid-row: 1; }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .dot {
      width: 18px; height: 18px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .dot.green { background: var(--green); box-shadow: 0 0 12px var(--green); animation: pulse-green 2s infinite; }
    .dot.red   { background: var(--red);   box-shadow: 0 0 12px var(--red);   animation: pulse-red   1s infinite; }
    .dot.yellow{ background: var(--yellow);box-shadow: 0 0 12px var(--yellow);animation: pulse-green 1.5s infinite; }
    @keyframes pulse-green { 0%,100%{opacity:1} 50%{opacity:.4} }
    @keyframes pulse-red   { 0%,100%{opacity:1} 50%{opacity:.3} }
    #status-text { font-size: 1.6rem; font-weight: bold; }
    .status-meta { font-size: 0.75rem; color: var(--muted); line-height: 1.8; }
    .status-meta span { color: var(--text); }

    /* Chaos controls */
    #chaos-card { grid-column: 1; grid-row: 2; }
    .chaos-select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
      font-family: var(--font);
      font-size: 0.78rem;
      margin-bottom: 10px;
    }
    .chaos-select option { background: var(--bg); }
    .btn-full { width: 100%; padding: 10px; font-size: 0.85rem; }
    .chaos-hint { font-size: 0.68rem; color: var(--muted); margin-top: 8px; text-align: center; }

    /* Logs */
    #logs-card { grid-column: 2; grid-row: 1; }
    .log-list { list-style: none; }
    .log-item {
      display: grid;
      grid-template-columns: 70px 52px 1fr;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.04);
      font-size: 0.78rem;
      animation: fadein .4s ease;
    }
    @keyframes fadein { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:none} }
    .log-ts   { color: var(--muted); }
    .log-level-INFO  { color: var(--blue); }
    .log-level-WARN  { color: var(--yellow); }
    .log-level-ERROR { color: var(--red); font-weight: bold; }
    .log-level-FATAL { color: var(--red); font-weight: bold; text-decoration: underline; }
    .log-msg { color: var(--text); }

    /* Runbook */
    #runbook-card { grid-column: 2; grid-row: 2; }
    .runbook-idle { color: var(--muted); font-size: 0.82rem; }
    .runbook-steps { list-style: none; }
    .rb-step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.04);
      font-size: 0.82rem;
      animation: fadein .3s ease;
    }
    .rb-icon { width: 22px; text-align: center; flex-shrink: 0; margin-top: 1px; }
    .rb-step-text { color: var(--text); flex: 1; }
    .rb-step-ts   { color: var(--muted); font-size: 0.7rem; flex-shrink: 0; }
    .rb-step.running .rb-step-text { color: var(--yellow); }
    .rb-step.done    .rb-icon::before { content: "âœ…"; }
    .rb-step.running .rb-icon::before { content: "â³"; animation: spin 1s linear infinite; }
    .rb-step.pending .rb-icon::before { content: "â”€â”€"; color: var(--muted); }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .rb-detail { font-size: 0.72rem; color: var(--muted); margin-top: 3px; }

    /* Incident summary */
    #summary-card {
      grid-column: 1 / -1;
      display: none;
      border-color: var(--green);
    }
    #summary-card.visible { display: block; animation: fadein .5s ease; }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-top: 12px;
    }
    .summary-item label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 4px; }
    .summary-item .val  { font-size: 1.1rem; color: var(--text); }
    .summary-item .val.big { font-size: 1.8rem; color: var(--green); }
    .summary-vs { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    /* Manual timeline */
    #manual-card {
      grid-column: 1 / -1;
      display: none;
      border-color: rgba(248,81,73,.35);
    }
    #manual-card.visible { display: block; animation: fadein .4s ease; }
    .manual-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .manual-timer {
      font-size: 1.4rem;
      color: var(--red);
      font-variant-numeric: tabular-nums;
    }
    .manual-timer.done { color: var(--muted); }
    .manual-steps { list-style: none; display: flex; flex-direction: column; gap: 6px; }
    .ms-step {
      display: grid;
      grid-template-columns: 70px 1fr;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      transition: background .3s;
    }
    .ms-step.pending  { color: var(--muted); }
    .ms-step.active   { background: rgba(248,81,73,.12); color: var(--text); }
    .ms-step.complete { background: rgba(248,81,73,.06); color: var(--muted); text-decoration: line-through; }
    .ms-time { color: var(--red); font-variant-numeric: tabular-nums; }
    .ms-step.pending .ms-time { color: var(--muted); }

    /* Code window */
    #code-card {
      grid-column: 1 / -1;
    }
    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .code-tabs { display: flex; gap: 6px; }
    .code-tab {
      padding: 4px 12px;
      border-radius: 5px;
      font-size: 0.72rem;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-family: var(--font);
      transition: all .2s;
    }
    .code-tab.active { background: var(--blue); color: #000; border-color: var(--blue); }
    .code-window {
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .code-window pre {
      margin: 0;
      padding: 16px;
      overflow-x: auto;
      font-size: 0.78rem;
      line-height: 1.6;
    }
    .code-window code { font-family: var(--font); }
    .code-badge {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(88,166,255,.15);
      color: var(--blue);
      border: 1px solid rgba(88,166,255,.3);
    }

    /* Connection status */
    #conn-bar {
      text-align: center;
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 14px;
    }
    #conn-bar.err { color: var(--red); }
  </style>
</head>
<body>

<header>
  <h1>ğŸ’³ <span>payment-service</span> â€” Live Demo Dashboard</h1>
  <div class="api-config">
    <input id="api-url" type="text" placeholder="https://your-api.onrender.com" />
    <button class="btn btn-blue" onclick="saveApiUrl()">Connect</button>
    <button class="btn btn-muted" id="btn-disconnect" onclick="disconnect()" style="display:none">âœ• Disconnect</button>
  </div>
</header>

<div id="conn-bar">â¬¤ Not connected â€” enter API URL above</div>

<div class="grid">

  <!-- STATUS -->
  <div class="card" id="status-card">
    <div class="card-title">Service Status</div>
    <div class="status-indicator">
      <div class="dot green" id="status-dot"></div>
      <div id="status-text">HEALTHY</div>
    </div>
    <div class="status-meta">
      Uptime: <span id="uptime">â€”</span><br>
      Last poll: <span id="last-poll">â€”</span>
    </div>
  </div>

  <!-- LOGS -->
  <div class="card" id="logs-card">
    <div class="card-title">Live Logs <span style="color:var(--muted);font-size:.65rem">(last 5)</span></div>
    <ul class="log-list" id="log-list">
      <li class="log-item"><span class="log-ts">â€”</span><span class="log-level-INFO">INFO</span><span class="log-msg">Waiting for connection...</span></li>
    </ul>
  </div>

  <!-- CHAOS CONTROLS -->
  <div class="card" id="chaos-card">
    <div class="card-title">Chaos Controls <span style="color:var(--muted);font-size:.65rem">(presenter only)</span></div>
    <select class="chaos-select" id="chaos-mode">
      <option value="connection_pool">ğŸ’€ Connection Pool Exhausted</option>
      <option value="timeout">â±ï¸ Downstream Timeout</option>
      <option value="random_crash">ğŸ’¥ Service Panic / Crash</option>
    </select>
    <button class="btn btn-red btn-full" id="btn-chaos" onclick="triggerChaos()">ğŸš¨ Trigger Chaos</button>
    <div style="margin-top:8px">
      <button class="btn btn-muted btn-full" onclick="resetService()">â†º Reset Service</button>
    </div>
    <div class="chaos-hint">Runbook auto-fires after ~8 seconds</div>
  </div>

  <!-- RUNBOOK -->
  <div class="card" id="runbook-card">
    <div class="card-title">ğŸ¤– Automated Runbook</div>
    <div class="runbook-idle" id="runbook-idle">â”€â”€ Watching for incidents...</div>
    <ul class="runbook-steps" id="runbook-steps" style="display:none"></ul>
  </div>

  <!-- MANUAL TIMELINE -->
  <div class="card" id="manual-card">
    <div class="manual-header">
      <div>
        <div class="card-title" style="margin-bottom:4px">â±ï¸ What Would Happen Manually</div>
        <div style="font-size:.72rem;color:var(--muted)">Average manual MTTR: <strong style="color:var(--red)">47 minutes</strong> &nbsp;<span style="color:var(--yellow);font-size:.68rem">âš¡ 47Ã— accelerated</span></div>
      </div>
      <div class="manual-timer" id="manual-timer">00:00</div>
    </div>
    <ul class="manual-steps" id="manual-steps"></ul>
  </div>

  <!-- INCIDENT SUMMARY -->
  <div class="card" id="summary-card">
    <div class="card-title" style="color:var(--green)">âœ… Incident Resolved</div>
    <div class="summary-grid">
      <div class="summary-item">
        <label>Root Cause</label>
        <div class="val" id="s-root">â€”</div>
      </div>
      <div class="summary-item">
        <label>Detected</label>
        <div class="val" id="s-detected">â€”</div>
      </div>
      <div class="summary-item">
        <label>Resolved</label>
        <div class="val" id="s-resolved">â€”</div>
      </div>
      <div class="summary-item">
        <label>MTTR (Automated)</label>
        <div class="val big" id="s-mttr">â€”</div>
        <div class="summary-vs" id="s-vs">vs ~47 min manual</div>
      </div>
    </div>
  </div>

  <!-- CODE WINDOW â€” bottom, hideable -->
  <div class="card" id="code-card" style="grid-column:1/-1">
    <div class="code-header">
      <div>
        <div class="card-title" style="margin-bottom:2px">ğŸ“„ Runbook as Code</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="code-tabs">
          <button class="code-tab active" onclick="showTab('runbook')">runbook.py</button>
          <button class="code-tab" onclick="showTab('trigger')">trigger.py</button>
          <button class="code-tab" onclick="showTab('health')">health_check.py</button>
        </div>
        <button class="btn btn-muted" id="btn-toggle-code" onclick="toggleCode()" style="font-size:0.72rem;padding:4px 10px">â–² Hide</button>
      </div>
    </div>
    <div id="code-body" style="display:none">
      <div class="code-window">
        <pre id="code-runbook"><code class="language-python"># runbook.py â€” automated incident response
# Auto-triggered when health check fails for > 8 seconds

import asyncio, time, httpx, logging

STEPS = [
    "Collect diagnostics & tail logs",
    "Notify on-call via Slack / PagerDuty",
    "Attempt service restart",
    "Verify recovery (health check loop)",
    "Close incident & write post-mortem",
]

async def run_runbook(incident_id: str, service_url: str):
    started_at = time.time()
    log = logging.getLogger("runbook")

    # â”€â”€ Step 1: Collect diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log.info("[1/5] Fetching last 50 log lines...")
    logs = await fetch_logs(service_url, last_n=50)
    root_cause = analyze_logs(logs)          # regex + pattern match
    log.info(f"  â†’ Root cause detected: {root_cause}")

    # â”€â”€ Step 2: Notify on-call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log.info("[2/5] Sending Slack alert...")
    await notify_slack(
        channel="#incidents",
        message=f"ğŸš¨ *{incident_id}* â€” {root_cause}\n"
                f"Runbook fired automatically. Attempting fix..."
    )

    # â”€â”€ Step 3: Restart service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log.info("[3/5] Restarting payment-service...")
    await restart_service(service_url)
    await asyncio.sleep(3)                   # grace period

    # â”€â”€ Step 4: Verify recovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log.info("[4/5] Waiting for healthy response...")
    healthy = await wait_for_health(service_url, timeout=30, interval=2)

    if not healthy:
        log.error("  âœ— Recovery failed â€” escalating to human")
        await notify_slack("#incidents", "âš ï¸ Auto-fix failed. Manual intervention needed.")
        return

    # â”€â”€ Step 5: Close incident â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    mttr = round(time.time() - started_at, 1)
    log.info(f"[5/5] Incident resolved. MTTR: {mttr}s")
    await notify_slack(
        "#incidents",
        f"âœ… *{incident_id}* resolved automatically\n"
        f"MTTR: *{mttr}s* (vs ~47 min manual = {round(2820/mttr)}Ã— faster)"
    )
    await write_postmortem(incident_id, root_cause, mttr)</code></pre>

        <pre id="code-trigger" style="display:none"><code class="language-python"># trigger.py â€” watches health endpoint, fires runbook on failure

import asyncio, time, httpx
from runbook import run_runbook

HEALTH_URL    = "https://payment-service.onrender.com/health"
CHECK_INTERVAL = 3    # seconds between polls
FAIL_THRESHOLD = 8    # seconds of failure before runbook fires

async def watch():
    failing_since = None

    while True:
        try:
            r = await httpx.AsyncClient().get(HEALTH_URL, timeout=5)
            if r.status_code == 200:
                failing_since = None          # reset on success
            else:
                raise ValueError(f"HTTP {r.status_code}")

        except Exception as e:
            if failing_since is None:
                failing_since = time.time()
                print(f"âš ï¸  Health check failed: {e}")

            elapsed = time.time() - failing_since
            if elapsed >= FAIL_THRESHOLD:
                print(f"ğŸš¨ Service down for {elapsed:.0f}s â€” firing runbook")
                failing_since = None          # prevent double-fire
                asyncio.create_task(
                    run_runbook(
                        incident_id=f"INC-{int(time.time())}",
                        service_url="https://payment-service.onrender.com"
                    )
                )

        await asyncio.sleep(CHECK_INTERVAL)

if __name__ == "__main__":
    asyncio.run(watch())</code></pre>

        <pre id="code-health" style="display:none"><code class="language-python"># health_check.py â€” used by runbook to verify recovery

import asyncio, httpx

async def wait_for_health(
    url: str,
    timeout: int = 30,
    interval: float = 2.0
) -> bool:
    """
    Polls /health every `interval` seconds.
    Returns True when 200 OK received, False if timeout exceeded.
    """
    deadline = asyncio.get_event_loop().time() + timeout

    async with httpx.AsyncClient() as client:
        while asyncio.get_event_loop().time() < deadline:
            try:
                r = await client.get(f"{url}/health", timeout=3)
                if r.status_code == 200:
                    data = r.json()
                    if data.get("status") == "healthy":
                        return True
            except Exception:
                pass  # still recovering

            await asyncio.sleep(interval)

    return False   # timed out


async def fetch_logs(url: str, last_n: int = 50) -> list[dict]:
    async with httpx.AsyncClient() as client:
        r = await client.get(f"{url}/logs?limit={last_n}", timeout=5)
        return r.json().get("logs", [])


def analyze_logs(logs: list[dict]) -> str:
    """Simple pattern matching to identify root cause."""
    for log in reversed(logs):
        msg = log.get("message", "").lower()
        if "connection pool" in msg:
            return "Connection pool exhausted"
        if "timeout" in msg:
            return "Downstream service timeout"
        if "panic" in msg or "crash" in msg:
            return "Service panic / unexpected crash"
    return "Unknown â€” see logs"</code></pre>
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let API_URL = localStorage.getItem('payment_demo_api') || '';
document.getElementById('api-url').value = API_URL;

function saveApiUrl() {
  API_URL = document.getElementById('api-url').value.trim().replace(/\/$/, '');
  localStorage.setItem('payment_demo_api', API_URL);
  document.getElementById('btn-disconnect').style.display = API_URL ? 'inline-block' : 'none';
  poll();
}

function disconnect() {
  API_URL = '';
  localStorage.removeItem('payment_demo_api');
  document.getElementById('api-url').value = '';
  document.getElementById('btn-disconnect').style.display = 'none';
  document.getElementById('conn-bar').textContent = 'â¬¤ Not connected â€” enter API URL above';
  document.getElementById('conn-bar').classList.remove('err');
  // reset UI
  incidentStartReal = null;
  manualDone = false;
  if (manualTimerInterval) clearInterval(manualTimerInterval);
  document.getElementById('manual-card').classList.remove('visible');
  document.getElementById('summary-card').classList.remove('visible');
  document.getElementById('manual-timer').classList.remove('done');
  document.getElementById('runbook-idle').style.display = 'block';
  document.getElementById('runbook-steps').style.display = 'none';
  lastStatus = null;
}

function showTab(name) {
  ['runbook', 'trigger', 'health'].forEach(t => {
    document.getElementById(`code-${t}`).style.display = t === name ? 'block' : 'none';
  });
  document.querySelectorAll('.code-tab').forEach((btn, i) => {
    const names = ['runbook', 'trigger', 'health'];
    btn.classList.toggle('active', names[i] === name);
  });
}

let codeVisible = false;
function toggleCode() {
  codeVisible = !codeVisible;
  document.getElementById('code-body').style.display = codeVisible ? 'block' : 'none';
  document.getElementById('btn-toggle-code').textContent = codeVisible ? 'â–² Hide' : 'â–¼ Show';
}

// â”€â”€ Manual timeline definition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const MANUAL_STEPS = [
  { time: 0,   label: 'On-call engineer gets paged'          },
  { time: 120, label: 'Wakes up, finds laptop'               },
  { time: 300, label: 'Logs into VPN + systems'              },
  { time: 480, label: 'Opens monitoring dashboard'           },
  { time: 900, label: 'Reads through logs manually'          },
  { time: 1380,label: 'Identifies root cause'                },
  { time: 1860,label: 'Executes fix manually'                },
  { time: 2280,label: 'Verifies recovery'                    },
  { time: 2640,label: 'Writes incident report'               },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let incidentStartReal = null;  // real Date.now() when chaos started
let manualTimerInterval = null;
let manualDone = false;
let lastStatus = null;

function fmtTime(secs) {
  const m = String(Math.floor(secs / 60)).padStart(2, '0');
  const s = String(secs % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function fmtUptime(secs) {
  if (secs < 60) return `${secs}s`;
  if (secs < 3600) return `${Math.floor(secs/60)}m ${secs%60}s`;
  return `${Math.floor(secs/3600)}h ${Math.floor((secs%3600)/60)}m`;
}

// â”€â”€ Manual Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startManualTimeline() {
  document.getElementById('manual-card').classList.add('visible');
  buildManualSteps();
  if (manualTimerInterval) clearInterval(manualTimerInterval);
  manualDone = false;
  manualTimerInterval = setInterval(tickManual, 1000);
}

function buildManualSteps() {
  const ul = document.getElementById('manual-steps');
  ul.innerHTML = '';
  MANUAL_STEPS.forEach((s, i) => {
    const li = document.createElement('li');
    li.className = 'ms-step pending';
    li.id = `ms-${i}`;
    li.innerHTML = `<span class="ms-time">${fmtTime(s.time)}</span><span>${s.label}</span>`;
    ul.appendChild(li);
  });
}

const MANUAL_SPEED = 47; // 47 real minutes compressed into ~60 real seconds

function tickManual() {
  if (!incidentStartReal) return;
  const realElapsed = Math.floor((Date.now() - incidentStartReal) / 1000);
  const manualElapsed = Math.min(realElapsed * MANUAL_SPEED, 47 * 60); // cap at 47 min
  document.getElementById('manual-timer').textContent = fmtTime(manualElapsed);

  MANUAL_STEPS.forEach((s, i) => {
    const el = document.getElementById(`ms-${i}`);
    if (!el) return;
    if (manualElapsed >= s.time) {
      const next = MANUAL_STEPS[i + 1];
      if (next && manualElapsed >= next.time) {
        el.className = 'ms-step complete';
      } else {
        el.className = 'ms-step active';
      }
    }
  });

  // Stop naturally at 47:00
  if (manualElapsed >= 47 * 60) {
    clearInterval(manualTimerInterval);
    manualTimerInterval = null;
    document.getElementById('manual-timer').classList.add('done');
    // mark all steps complete
    MANUAL_STEPS.forEach((s, i) => {
      const el = document.getElementById(`ms-${i}`);
      if (el) el.className = 'ms-step complete';
    });
  }
}

// â”€â”€ Poll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function poll() {
  if (!API_URL) return;
  try {
    const res = await fetch(`${API_URL}/state`);
    const d = await res.json();

    document.getElementById('conn-bar').textContent = `â¬¤ Connected to ${API_URL}`;
    document.getElementById('conn-bar').classList.remove('err');
    document.getElementById('last-poll').textContent = new Date().toLocaleTimeString();

    // Status
    updateStatus(d.status);
    document.getElementById('uptime').textContent = fmtUptime(d.uptime);

    // Logs
    updateLogs(d.logs);

    // Chaos just started?
    if (d.status !== 'healthy' && lastStatus === 'healthy') {
      incidentStartReal = Date.now();
      startManualTimeline();
      document.getElementById('summary-card').classList.remove('visible');
    }
    lastStatus = d.status;

    // Runbook
    updateRunbook(d.runbook_steps, d.runbook_running);

    // Resolved?
    if (d.mttr !== null && d.status === 'healthy' && d.incident_resolved_at) {
      showSummary(d);
      // manual timer keeps running â€” stops naturally at 47:00 in tickManual()
    }

  } catch (e) {
    document.getElementById('conn-bar').textContent = `â¬¤ Cannot reach ${API_URL} â€” ${e.message}`;
    document.getElementById('conn-bar').classList.add('err');
  }
}

function updateStatus(status) {
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');

  dot.className = 'dot';
  if (status === 'healthy') {
    dot.classList.add('green');
    text.textContent = 'HEALTHY';
    text.style.color = 'var(--green)';
  } else if (status === 'unhealthy') {
    dot.classList.add('red');
    text.textContent = 'UNHEALTHY';
    text.style.color = 'var(--red)';
  } else {
    dot.classList.add('yellow');
    text.textContent = 'RECOVERING';
    text.style.color = 'var(--yellow)';
  }
}

function updateLogs(logs) {
  if (!logs || !logs.length) return;
  const ul = document.getElementById('log-list');
  ul.innerHTML = '';
  [...logs].reverse().forEach(log => {
    const li = document.createElement('li');
    li.className = 'log-item';
    li.innerHTML = `
      <span class="log-ts">${log.timestamp}</span>
      <span class="log-level-${log.level}">${log.level}</span>
      <span class="log-msg">${log.message}</span>`;
    ul.appendChild(li);
  });
}

function updateRunbook(steps, running) {
  const idle  = document.getElementById('runbook-idle');
  const ul    = document.getElementById('runbook-steps');

  if (!steps || steps.length === 0) {
    idle.style.display = 'block';
    ul.style.display = 'none';
    return;
  }

  idle.style.display = 'none';
  ul.style.display = 'block';
  ul.innerHTML = '';

  steps.forEach((s, i) => {
    const li = document.createElement('li');
    li.className = `rb-step ${s.status}`;
    li.innerHTML = `
      <span class="rb-icon"></span>
      <div>
        <div class="rb-step-text">[${i+1}/5] ${s.step}</div>
        ${s.detail ? `<div class="rb-detail">â†’ ${s.detail}</div>` : ''}
      </div>
      <span class="rb-step-ts">${s.ts}</span>`;
    ul.appendChild(li);
  });
}

function showSummary(d) {
  const card = document.getElementById('summary-card');
  card.classList.add('visible');

  document.getElementById('s-root').textContent = d.root_cause || 'â€”';

  const detectedDate = new Date(d.incident_started_at * 1000);
  const resolvedDate = new Date(d.incident_resolved_at * 1000);
  document.getElementById('s-detected').textContent = detectedDate.toLocaleTimeString();
  document.getElementById('s-resolved').textContent = resolvedDate.toLocaleTimeString();

  const mttr = d.mttr;
  const manualSec = 47 * 60;
  const speedup = Math.round(manualSec / mttr);
  document.getElementById('s-mttr').textContent = `${mttr}s`;
  document.getElementById('s-vs').textContent = `vs ~47 min manually â€” ${speedup}Ã— faster`;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function triggerChaos() {
  if (!API_URL) { alert('Enter API URL first'); return; }
  const mode = document.getElementById('chaos-mode').value;
  await fetch(`${API_URL}/admin/chaos`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ mode, auto_runbook_delay: 8 })
  });
  poll();
}

async function resetService() {
  if (!API_URL) { alert('Enter API URL first'); return; }
  await fetch(`${API_URL}/admin/reset`, { method: 'POST' });
  incidentStartReal = null;
  manualDone = false;
  if (manualTimerInterval) clearInterval(manualTimerInterval);
  document.getElementById('manual-card').classList.remove('visible');
  document.getElementById('summary-card').classList.remove('visible');
  document.getElementById('manual-timer').classList.remove('done');
  document.getElementById('runbook-idle').style.display = 'block';
  document.getElementById('runbook-steps').style.display = 'none';
  lastStatus = null;
  poll();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('DOMContentLoaded', () => {
  hljs.highlightAll();
  if (API_URL) {
    document.getElementById('btn-disconnect').style.display = 'inline-block';
    poll();
  }
});
setInterval(poll, 3000);
</script>
</body>
</html>
